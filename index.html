<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biểu Mẫu Khảo Sát Hố Thang Máy</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00897b">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* BASE & MOBILE-FIRST STYLES */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 5px; /* Tối ưu hóa: 5px */
            background-color: #f5f8fa; 
        }
        .container {
            max-width: 650px; 
            margin: 0 auto;
            background-color: #ffffff;
            padding: 10px; /* Tối ưu hóa: 10px */
            border-radius: 16px; 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); 
            position: relative; 
        }
        h1 {
            color: #00897b; 
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 10px; /* Tối ưu hóa: 10px */
            border-bottom: 2px solid #00897b;
            padding-bottom: 5px; /* Tối ưu hóa: 5px */
        }
        .section-header {
            background-color: #00bcd4; 
            color: white;
            padding: 7px 10px; /* Tối ưu hóa: 7px/10px */
            border-radius: 10px 10px 0 0;
            font-size: 1.3em;
            margin-top: 10px; /* Tối ưu hóa: 10px */
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        .section-header i {
            margin-right: 5px; /* Tối ưu hóa: 5px */
        }
        .info-card {
            background-color: #e0f7fa; 
            border: 1px solid #b2ebf2;
            padding: 10px; /* Tối ưu hóa: 10px */
            border-radius: 0 0 10px 10px;
            margin-bottom: 10px; /* Tối ưu hóa: 10px */
        }
        
        .form-group {
            margin-bottom: 5px; /* Tối ưu hóa: 5px */
            display: flex;
            align-items: center;
            flex-wrap: wrap; 
        }
        .form-group label {
            min-width: 100px;
            font-weight: 600;
            color: #37474f; 
            font-size: 1em;
        }
        .form-group.stacked label {
            width: 100%;
            margin-bottom: 5px; /* Tối ưu hóa: 5px */
            margin-left: 0;
        }
        input[type="text"] {
            flex-grow: 1;
            padding: 5px; /* Tối ưu hóa: 5px */
            border: 1px solid #cfd8dc; 
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-left: 5px; /* Tối ưu hóa: 5px */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus {
            border-color: #00bcd4;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.2);
            outline: none;
        }
        .input-pair-wrapper {
            display: flex; 
            width: 100%; 
            justify-content: space-between;
        }
        .input-pair-wrapper input {
            width: calc(50% - 5px); 
            margin: 0;
        }
        #standardRoughSize {
            font-size: 0.9em;
            font-weight: bold;
            color: #00897b;
            margin-top: 5px; 
            padding-left: 5px;
        }

        /* TABLE STYLES & HIGHLIGHTS */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; /* Tối ưu hóa: 10px */
            font-size: 0.9em;
            border-radius: 8px;
            overflow: hidden;
        }
        .data-table th, .data-table td {
            border: 1px solid #e0f7fa; 
            padding: 5px 3px; /* Tối ưu hóa: 5px/3px */
            text-align: center;
            position: relative;
        }
        .data-table th {
            background-color: #00838f; 
            color: white;
            font-weight: 600;
        }
        .data-table input {
            width: 100%;
            padding: 3px; /* Tối ưu hóa: 3px */
            border: none;
            box-sizing: border-box;
            text-align: center;
            background-color: transparent;
        }
        .data-table .action-cell {
            padding: 0;
            width: 30px; 
        }
        .btn-apply {
            background: none;
            border: none;
            color: #2196f3; 
            cursor: pointer;
            font-size: 1.2em;
            padding: 5px;
            transition: color 0.2s, background-color 0.2s;
        }
        .btn-apply:hover {
            color: #0d47a1;
        }
        .btn-apply.flash {
            animation: flashGreen 0.5s;
        }
        @keyframes flashGreen {
            0% { background-color: transparent; }
            50% { background-color: #a5d6a7; } 
            100% { background-color: transparent; }
        }
        .min-value { background-color: #ffcdd2 !important; font-weight: bold; color: #c62828 !important; }
        .max-value { background-color: #c8e6c9 !important; font-weight: bold; color: #388e3c !important; }
        .comparison-smaller { background-color: #fff8e1 !important; }
        .comparison-larger { background-color: #e8f5e9 !important; }
        .oh-row { background-color: #fffde7 !important; font-weight: bold; }
        .pit-row { background-color: #e1f5fe !important; font-weight: bold; color: #01579b; }

        /* BUTTON GROUP STYLES */
        .btn-controls {
            display: flex;
            gap: 5px; /* Tối ưu hóa: 5px */
            margin-top: 10px; /* Tối ưu hóa: 10px */
            width: 100%;
        }
        .btn-controls button {
            flex: 1;
            padding: 8px; /* Tối ưu hóa: 8px */
            border: none;
            border-radius: 6px; 
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-add { background-color: #4db6ac; color: white; }
        .btn-add:hover { background-color: #00897b; }
        .btn-reduce { background-color: #ffb74d; color: #37474f; }
        .btn-reduce:hover { background-color: #ff9800; }
        .btn-reduce:disabled { background-color: #eeeeee; color: #bdbdbd; cursor: not-allowed; box-shadow: none; }
        .btn-save { background-color: #607d8b; color: white; margin-top: 10px; }
        .btn-save:hover { background-color: #455a64; }

        /* Vùng Ngày In */
        #print-date-info {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 0.8em;
            color: #757575;
            display: none; 
            z-index: 10;
        }
        

        /* --- PRINT STYLES (TỐI ƯU IN ẤN ĐEN TRẮNG VÀ KHOẢNG CÁCH) --- */
        @media print {
            /* Hiển thị ngày in ở góc trên bên phải */
            #print-date-info {
                display: block !important;
                position: fixed; 
                top: 5px;
                right: 5px;
                color: #000 !important;
                font-weight: bold;
            }
            
            body { 
                padding: 0;
            }
            .container {
                box-shadow: none;
                border: none;
                padding: 5px; 
                max-width: 100%;
            }
            h1 {
                margin-top: 20px; 
            }

            .section-header {
                padding: 5px;
                margin-top: 5px;
                border: 1px solid #000;
                background-color: #ccc !important;
                color: #000 !important;
                border-radius: 0;
            }
            .info-card {
                padding: 5px;
                margin-bottom: 5px;
                border: 1px solid #000;
                background-color: #fff !important;
                border-radius: 0;
            }
            .data-table {
                margin-top: 5px;
            }
            .data-table th, .data-table td {
                border: 1px solid #000 !important;
                padding: 4px 2px;
                color: #000 !important;
                background-color: #fff !important;
            }
            .data-table th {
                background-color: #ccc !important; 
            }
            .min-value, .max-value, .comparison-smaller, .comparison-larger { 
                background-color: transparent !important; 
                font-weight: bold; 
                color: #000 !important; 
            }
            .oh-row, .pit-row { 
                background-color: #eee !important; 
                font-weight: bold; 
                color: #000 !important;
            }
            .data-table input {
                border: none;
                text-align: center;
                display: inline;
                padding: 0;
                color: #000 !important;
            }
            .data-table input[value*='*'] {
                color: red !important;
            }
            /* ẨN CÁC THÀNH PHẦN KHÔNG CẦN THIẾT KHI IN */
            .btn-controls, .btn-save, .btn-apply {
                display: none !important;
            }
            #cuaTangHeaderTable th:last-child, #cuaTangTable td:last-child {
                display: none;
            }
        }
    </style>
</head>
<body onbeforeunload="saveState()">

<div class="container">
    <div id="print-date-info">Ngày: <span id="current-date"></span></div>
    
    <h1><i class="fas fa-ruler-combined"></i> BIỂU MẪU KHẢO SÁT HỐ THANG MÁY</h1>
    
    <div class="section-header">
        <i class="fas fa-file-contract"></i> THÔNG SỐ HỢP ĐỒNG/BẢN VẼ
    </div>
    <div class="info-card">
        
        <div class="form-group">
            <label>Tên Công Trình:</label>
            <input type="text" id="projectName" placeholder="Nhập tên công trình" oninput="saveState()">
        </div>
        <div class="form-group">
            <label>Địa Chỉ:</label>
            <input type="text" id="projectAddress" placeholder="Nhập địa chỉ công trình" oninput="saveState()">
        </div>
        
        <hr style="border: 0; border-top: 1px dashed #cfd8dc; margin: 10px 0;">
        
        <div class="form-group stacked">
            <label>Hố Thang (Thiết kế) - WxL:</label>
            <div class="input-pair-wrapper">
                <input type="text" id="masterWidth" placeholder="Rộng TK (mm)" oninput="handleMasterDimensionsChange()">
                <span style="align-self: center;">x</span>
                <input type="text" id="masterDepth" placeholder="Sâu TK (mm)" oninput="handleMasterDimensionsChange()">
            </div>
        </div>
        
        <div class="form-group stacked">
            <label>Kích thước Cửa Tầng (Thông thủy):</label>
            <div class="input-pair-wrapper">
                <input type="text" id="masterDoorW" placeholder="Rộng Cửa (TT - mm)" oninput="handleDoorInput()">
                <span style="align-self: center;">x</span>
                <input type="text" id="masterDoorH" placeholder="Cao Cửa (TT - mm)" oninput="handleDoorInput()">
            </div>
        </div>
        
        <div id="standardRoughSize"></div>
        
        <div class="form-group">
            <label>Số Điểm Dừng (N):</label>
            <input type="text" id="soTangDisplay" value="5" readonly style="font-weight: bold; background-color: #e0f7fa; width: 60px; margin-left: 5px;">
        </div>
    </div>
    
    <div class="section-header">
        <i class="fas fa-layer-group"></i> 1. KÍCH THƯỚC GIẾNG THANG (Rộng x Sâu & Cao/Sâu)
    </div>
    <div class="info-card">
        
        <table class="data-table" id="giengThangTable">
            <thead>
                <tr>
                    <th>Khu Vực</th>
                    <th>Rộng (mm)</th>
                    <th>Sâu (mm)</th>
                    <th>Cao/Sâu (mm)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        
        <div class="btn-controls">
            <button class="btn-reduce" id="btnReduce" onclick="reduceFloor()">
                <i class="fas fa-minus-circle"></i> GIẢM SỐ ĐIỂM DỪNG
            </button>
            <button class="btn-add" onclick="addFloor()">
                <i class="fas fa-plus-circle"></i> TĂNG SỐ ĐIỂM DỪNG
            </button>
        </div>
    </div>

    <div class="section-header">
        <i class="fas fa-door-open"></i> 2. KÍCH THƯỚC CỬA TẦNG (W1, W, H, W2)
    </div>
    <div class="info-card">
        <table class="data-table" id="cuaTangHeaderTable">
            <thead>
                <tr>
                    <th>Tầng</th>
                    <th>W1 (Trái)</th>
                    <th>Rộng (W)</th>
                    <th>Cao (H)</th>
                    <th>W2 (Phải)</th>
                    <th>Áp dụng</th> 
                </tr>
            </thead>
            <tbody id="cuaTangTable">
                </tbody>
        </table>
        <p style="font-size: 0.75em; color: #555; margin-top: 5px;">*W1, W2 là khoảng cách cánh gà. WxH là lỗ chờ thô. Dấu '*' cảnh báo kích thước nhỏ hơn tiêu chuẩn.</p>
    </div>
    
    <button class="btn-controls btn-save" onclick="printToPDF()">
        <i class="fas fa-print"></i> LƯU DỮ LIỆU / IN (PDF)
    </button>
    <div id="saveStatus" style="text-align: right; font-size: 0.8em; color: #757575; margin-top: 5px;"></div>

</div>

<script>
    let currentServiceFloors = 5; 
    const giengThangTableBody = document.getElementById('giengThangTable').querySelector('tbody');
    const cuaTangTableBody = document.getElementById('cuaTangTable');
    const soTangDisplay = document.getElementById('soTangDisplay');
    const btnReduce = document.getElementById('btnReduce');
    const standardRoughSizeDisplay = document.getElementById('standardRoughSize');
    const saveStatusDisplay = document.getElementById('saveStatus');
    const currentDateDisplay = document.getElementById('current-date');

    const giengThangColsToHighlight = [0, 1]; 
    const doorColumnsToHighlight = [0, 1, 2, 3]; 

    let autoSaveInterval;

    // --- UTILITIES ---

    function getNumericValue(input) {
        let value = input.value.replace('*', '').replace(',', '.');
        return parseFloat(value) || NaN;
    }

    function updateInputValue(input, value, addStar) {
        if (isNaN(value)) {
            input.value = '';
            return;
        }
        
        let cleanValue = String(value).replace('*', '');
        
        const finalValue = addStar ? cleanValue + '*' : cleanValue;
        
        if (input.value !== finalValue) {
             input.value = finalValue;
        }
    }
    
    function getAllInputs() {
        const inputElements = document.querySelectorAll('input[type="text"]');
        return Array.from(inputElements);
    }
    
    // --- AUTOSAVE & RESTORE STATE ---

    function saveState() {
        const state = {
            floors: currentServiceFloors,
            inputValues: {}
        };
        
        getAllInputs().forEach(input => {
            if (input.id !== 'soTangDisplay') {
                state.inputValues[input.id] = input.value;
            } else {
                state.floors = parseInt(input.value) || 1;
            }
        });

        const tableData = {
            giengThang: [],
            cuaTang: []
        };
        
        giengThangTableBody.querySelectorAll('tr').forEach((row) => {
            const rowData = [];
            row.querySelectorAll('input[type="text"]').forEach(input => {
                rowData.push(input.value);
            });
            tableData.giengThang.push(rowData);
        });

        cuaTangTableBody.querySelectorAll('tr').forEach((row) => {
            const rowData = [];
            row.querySelectorAll('input[type="text"]').forEach(input => {
                rowData.push(input.value);
            });
            tableData.cuaTang.push(rowData);
        });
        
        state.tableData = tableData;

        try {
            localStorage.setItem('elevatorSurveyState', JSON.stringify(state));
            saveStatusDisplay.textContent = 'Đã lưu tự động lúc ' + new Date().toLocaleTimeString('vi-VN');
        } catch (e) {
            console.error("Lỗi khi lưu localStorage:", e);
            saveStatusDisplay.textContent = 'Không thể lưu tự động.';
        }
    }

    function restoreState() {
        try {
            const savedState = localStorage.getItem('elevatorSurveyState');
            if (!savedState) {
                renderTables(currentServiceFloors);
                return;
            }
            
            const state = JSON.parse(savedState);
            currentServiceFloors = state.floors || 5;
            
            renderTables(currentServiceFloors); 

            // Khôi phục giá trị input chính
            document.getElementById('projectName').value = state.inputValues.projectName || '';
            document.getElementById('projectAddress').value = state.inputValues.projectAddress || '';
            document.getElementById('masterWidth').value = state.inputValues.masterWidth || '';
            document.getElementById('masterDepth').value = state.inputValues.masterDepth || '';
            document.getElementById('masterDoorW').value = state.inputValues.masterDoorW || '';
            document.getElementById('masterDoorH').value = state.inputValues.masterDoorH || '';

            // Khôi phục giá trị các bảng
            if (state.tableData) {
                giengThangTableBody.querySelectorAll('tr').forEach((row, rowIndex) => {
                    if (state.tableData.giengThang[rowIndex]) {
                        row.querySelectorAll('input[type="text"]').forEach((input, colIndex) => {
                            input.value = state.tableData.giengThang[rowIndex][colIndex] || '';
                        });
                    }
                });

                cuaTangTableBody.querySelectorAll('tr').forEach((row, rowIndex) => {
                    if (state.tableData.cuaTang[rowIndex]) {
                        row.querySelectorAll('input[type="text"]').forEach((input, colIndex) => {
                            input.value = state.tableData.cuaTang[rowIndex][colIndex] || '';
                        });
                    }
                });
            }
            
            handleDoorInput();
            handleMasterDimensionsChange();
            saveStatusDisplay.textContent = 'Đã khôi phục dữ liệu đã lưu.';

        } catch (e) {
            console.error("Lỗi khi khôi phục localStorage:", e);
            renderTables(currentServiceFloors);
        }
    }
    
    function startAutoSave() {
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        autoSaveInterval = setInterval(saveState, 10000); // Lưu sau mỗi 10 giây
    }

    // --- EVENT HANDLERS ---

    function handleMasterDimensionsChange() {
        compareGiengThangDimensions();
        handleDoorInput(); 
        saveState();
    }
    
    function handleDoorInput() {
        updateStandardRoughSize();
        validateDoorDimensions(); 
        saveState();
    }

    function handleInputEvent(type) {
        if (type === 'giengthang') {
            compareGiengThangDimensions();
            highlightMinMaxValues(giengThangTableBody, giengThangColsToHighlight);
        } else if (type === 'cuatang') {
            validateDoorDimensions(); 
            highlightMinMaxValues(cuaTangTableBody, doorColumnsToHighlight);
        }
        saveState();
    }

    function updateCurrentDateDisplay() {
        const today = new Date();
        const formattedDate = today.toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        currentDateDisplay.textContent = formattedDate;
    }


    // --- LOGIC FUNCTIONS ---

    function updateStandardRoughSize() {
        const masterDoorW = getNumericValue(document.getElementById('masterDoorW'));
        const masterDoorH = getNumericValue(document.getElementById('masterDoorH'));
        
        if (!isNaN(masterDoorW) && !isNaN(masterDoorH)) {
            const stdRoughW = masterDoorW + 200; 
            const stdRoughH = masterDoorH + 150; 
            standardRoughSizeDisplay.innerHTML = `**Kích thước chờ thô Tiêu chuẩn (W x H):** ${stdRoughW} mm x ${stdRoughH} mm`;
        } else {
            standardRoughSizeDisplay.innerHTML = '';
        }
    }

    function highlightMinMaxValues(tableBody, colIndices) {
        colIndices.forEach(colIndex => {
            let minVal = Infinity;
            let maxVal = -Infinity;
            let minInputs = [];
            let maxInputs = [];

            tableBody.querySelectorAll('tr').forEach(row => {
                const inputs = row.querySelectorAll('input[type="text"]');
                if (inputs.length > colIndex) {
                    const input = inputs[colIndex];
                    input.classList.remove('min-value', 'max-value');

                    const val = getNumericValue(input);
                    if (!isNaN(val)) {
                        if (val < minVal) {
                            minVal = val;
                            minInputs = [input];
                        } else if (val === minVal) {
                            minInputs.push(input);
                        }
                        if (val > maxVal) {
                            maxVal = val;
                            maxInputs = [input];
                        } else if (val === maxVal) {
                            maxInputs.push(input);
                        }
                    }
                }
            });

            if (minVal !== Infinity) {
                minInputs.forEach(input => input.classList.add('min-value'));
            }

            if (maxVal !== -Infinity && maxVal > minVal) {
                maxInputs.forEach(input => input.classList.add('max-value'));
            }
        });
    }

    function compareGiengThangDimensions() {
        const masterW = getNumericValue(document.getElementById('masterWidth'));
        const masterD = getNumericValue(document.getElementById('masterDepth'));

        giengThangTableBody.querySelectorAll('tr').forEach(row => {
            const inputs = row.querySelectorAll('input[type="text"]');
            
            if (inputs.length < 2) return; 

            const inputW = inputs[0];
            const valW = getNumericValue(inputW);
            inputW.classList.remove('comparison-smaller', 'comparison-larger');
            if (!isNaN(valW) && !isNaN(masterW)) {
                if (valW < masterW) {
                    inputW.classList.add('comparison-smaller'); 
                } else if (valW > masterW) {
                    inputW.classList.add('comparison-larger'); 
                }
            }

            const inputD = inputs[1];
            const valD = getNumericValue(inputD);
            inputD.classList.remove('comparison-smaller', 'comparison-larger');
            if (!isNaN(valD) && !isNaN(masterD)) {
                if (valD < masterD) {
                    inputD.classList.add('comparison-smaller'); 
                } else if (valD > masterD) {
                    inputD.classList.add('comparison-larger'); 
                }
            }
        });
        highlightMinMaxValues(giengThangTableBody, giengThangColsToHighlight);
    }

    function validateDoorDimensions() {
        const masterDoorW = getNumericValue(document.getElementById('masterDoorW'));
        const masterDoorH = getNumericValue(document.getElementById('masterDoorH'));
        
        const stdRoughW = masterDoorW + 200; 
        const stdRoughH = masterDoorH + 150; 

        const isMasterValid = !isNaN(masterDoorW) && !isNaN(masterDoorH);
        
        cuaTangTableBody.querySelectorAll('tr').forEach(row => {
            const inputs = row.querySelectorAll('input[type="text"]');
            
            const inputW = inputs[1];
            const valW = getNumericValue(inputW);
            
            const inputH = inputs[2];
            const valH = getNumericValue(inputH);

            if (isMasterValid) {
                const shouldStarW = !isNaN(valW) && valW < stdRoughW;
                updateInputValue(inputW, valW, shouldStarW);
                
                const shouldStarH = !isNaN(valH) && valH < stdRoughH;
                updateInputValue(inputH, valH, shouldStarH);
            } else {
                updateInputValue(inputW, valW, false);
                updateInputValue(inputH, valH, false);
            }
        });
        
        highlightMinMaxValues(cuaTangTableBody, doorColumnsToHighlight);
    }
    
    // --- TĂNG/GIẢM TẦNG ---
    
    function addFloor() {
        currentServiceFloors++;
        renderTables(currentServiceFloors);
        saveState();
    }

    function reduceFloor() {
        if (currentServiceFloors > 1) {
            currentServiceFloors--;
            renderTables(currentServiceFloors);
            saveState();
        } else {
            alert('Số điểm dừng không thể nhỏ hơn 1!');
        }
    }
    
    /**
     * Cải tiến: Áp dụng kích thước cửa tầng cho tầng ngay bên dưới và flash nút.
     */
    function applyDoorDimensions(sourceRowIndex, buttonElement) {
        const sourceRow = cuaTangTableBody.rows[sourceRowIndex];
        const sourceInputs = sourceRow.querySelectorAll('input[type="text"]');
        
        const w1 = sourceInputs[0].value;
        const w = sourceInputs[1].value;
        const h = sourceInputs[2].value;
        const w2 = sourceInputs[3].value;
        
        const targetRowIndex = sourceRowIndex + 1;
        
        if (targetRowIndex < cuaTangTableBody.rows.length) {
            const targetRow = cuaTangTableBody.rows[targetRowIndex];
            const targetInputs = targetRow.querySelectorAll('input[type="text"]');
            
            // Chỉ điền vào nếu ô đích đang trống
            if (!targetInputs[0].value) targetInputs[0].value = w1;
            if (!targetInputs[1].value) targetInputs[1].value = w;
            if (!targetInputs[2].value) targetInputs[2].value = h;
            if (!targetInputs[3].value) targetInputs[3].value = w2;
            
            // Thêm hiệu ứng flash
            buttonElement.classList.add('flash');
            setTimeout(() => {
                buttonElement.classList.remove('flash');
            }, 500);

            // Chạy lại validation và lưu trạng thái
            handleInputEvent('cuatang');
        } else {
            alert('Không có tầng nào bên dưới để áp dụng.');
        }
    }
    
    /**
     * Lưu dữ liệu dưới dạng PDF (In)
     */
    function printToPDF() {
        window.print();
    }


    function updateFloorDisplay(numFloors) {
        soTangDisplay.value = numFloors; 
        btnReduce.disabled = (numFloors <= 1);
    }

    // --- RENDER FUNCTIONS ---

    function renderTables(numFloors) {
        giengThangTableBody.innerHTML = '';
        cuaTangTableBody.innerHTML = '';
        
        const pitRow = giengThangTableBody.insertRow();
        pitRow.classList.add('pit-row');
        pitRow.innerHTML = `
            <td>PIT</td>
            <td><input type="text" placeholder="Rộng PIT" oninput="handleInputEvent('giengthang')"></td>
            <td><input type="text" placeholder="Sâu PIT" oninput="handleInputEvent('giengthang')"></td>
            <td><input type="text" placeholder="Độ Sâu P"></td>
        `;
        
        for (let i = 1; i <= numFloors; i++) {
            createGiengThangRow(i, numFloors); 
            createCuaTangRow(i, numFloors); 
        }
        
        updateFloorDisplay(numFloors);
    }

    function createGiengThangRow(floorIndex, totalFloors) {
        const isOH = floorIndex === totalFloors;
        const row = giengThangTableBody.insertRow();
        
        if (isOH) {
            row.classList.add('oh-row');
        }

        const name = isOH ? `Tầng ${floorIndex} (OH)` : `Tầng ${floorIndex}`;
        const heightPlaceholder = isOH ? 'Chiều Cao OH' : 'Cao H';
        
        row.innerHTML = `
            <td>${name}</td>
            <td><input type="text" placeholder="Rộng" oninput="handleInputEvent('giengthang')"></td>
            <td><input type="text" placeholder="Sâu" oninput="handleInputEvent('giengthang')"></td>
            <td><input type="text" placeholder="${heightPlaceholder}"></td>
        `;
    }

    function createCuaTangRow(floorIndex, totalFloors) {
        const isOH = floorIndex === totalFloors;
        const row = cuaTangTableBody.insertRow();
        
        const name = isOH ? `Tầng ${floorIndex} (OH)` : `Tầng ${floorIndex}`;

        // Chỉ hiển thị nút Áp dụng nếu không phải là tầng cuối cùng (OH)
        const applyButton = isOH 
            ? '<span>---</span>'
            : `<button class="btn-apply" title="Áp dụng kích thước cửa này cho tầng ngay bên dưới (nếu trống)" onclick="applyDoorDimensions(${floorIndex - 1}, this)">
                    <i class="fas fa-arrow-down"></i>
                </button>`;

        row.innerHTML = `
            <td>${name}</td>
            <td><input type="text" placeholder="W1" oninput="handleInputEvent('cuatang')"></td>
            <td><input type="text" placeholder="W" oninput="handleInputEvent('cuatang')"></td>
            <td><input type="text" placeholder="H" oninput="handleInputEvent('cuatang')"></td>
            <td><input type="text" placeholder="W2" oninput="handleInputEvent('cuatang')"></td>
            <td class="action-cell">${applyButton}</td>
        `;
    }

    function initializeTables() {
        updateCurrentDateDisplay();
        restoreState(); 
        startAutoSave();
    }
    
    document.addEventListener('DOMContentLoaded', initializeTables);
    
    // Đăng ký Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Thay đổi đường dẫn service-worker.js nếu cần
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

</script>

</body>
</html>